!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("../python/python"),require("../stex/stex"),require("../../addon/mode/overlay")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../python/python","../stex/stex","../../addon/mode/overlay"],e):e(CodeMirror)}(function(U){"use strict";U.defineMode("rst",function(e,t){var a=/^\*\*[^\*\s](?:[^\*]*[^\*\s])?\*\*/,c=/^\*[^\*\s](?:[^\*]*[^\*\s])?\*/,n=/^``[^`\s](?:[^`]*[^`\s])``/,r=/^(?:[\d]+(?:[\.,]\d+)*)/,m=/^(?:\s\+[\d]+(?:[\.,]\d+)*)/,o=/^(?:\s\-[\d]+(?:[\.,]\d+)*)/,s=new RegExp("^[Hh][Tt][Tt][Pp][Ss]?://(?:[\\d\\w.-]+)\\.(?:\\w{2,6})(?:/[\\d\\w\\#\\%\\&\\-\\.\\,\\/\\:\\=\\?\\~]+)*"),h={token:function(e){if(e.match(a)&&e.match(/\W+|$/,!1))return"strong";if(e.match(c)&&e.match(/\W+|$/,!1))return"em";if(e.match(n)&&e.match(/\W+|$/,!1))return"string-2";if(e.match(r))return"number";if(e.match(m))return"positive";if(e.match(o))return"negative";if(e.match(s))return"link";for(;!(null==e.next()||e.match(a,!1)||e.match(c,!1)||e.match(n,!1)||e.match(r,!1)||e.match(m,!1)||e.match(o,!1)||e.match(s,!1)););return null}},l=U.getMode(e,t.backdrop||"rst-base");return U.overlayMode(l,h,!0)},"python","stex"),U.defineMode("rst-base",function(e){function t(e){var a=Array.prototype.slice.call(arguments,1);return e.replace(/{(\d+)}/g,function(e,t){return void 0!==a[t]?a[t]:e})}var c=U.getMode(e,"python"),n=U.getMode(e,"stex"),a="\\s+",r="(?:\\s*|\\W|$)",m=new RegExp(t("^{0}",r)),o="(?:[^\\W\\d_](?:[\\w!\"#$%&'()\\*\\+,\\-\\./:;<=>\\?]*[^\\W_])?)",s=new RegExp(t("^{0}",o)),h=t("(?:{0}|`{1}`)",o,"(?:[^\\W\\d_](?:[\\w\\s!\"#$%&'()\\*\\+,\\-\\./:;<=>\\?]*[^\\W_])?)"),l="(?:[^\\s\\|](?:[^\\|]*[^\\s\\|])?)",i="(?:[^\\`]+)",p=new RegExp(t("^{0}",i)),d=new RegExp("^([!'#$%&\"()*+,-./:;<=>?@\\[\\\\\\]^_`{|}~])\\1{3,}\\s*$"),u=new RegExp(t("^\\.\\.{0}",a)),x=new RegExp(t("^_{0}:{1}|^__:{1}",h,r)),f=new RegExp(t("^{0}::{1}",h,r)),k=new RegExp(t("^\\|{0}\\|{1}{2}::{3}",l,a,h,r)),w=new RegExp(t("^\\[(?:\\d+|#{0}?|\\*)]{1}",h,r)),b=new RegExp(t("^\\[{0}\\]{1}",h,r)),g=new RegExp(t("^\\|{0}\\|",l)),E=new RegExp(t("^\\[(?:\\d+|#{0}?|\\*)]_",h)),R=new RegExp(t("^\\[{0}\\]_",h)),y=new RegExp(t("^{0}__?",h)),_=new RegExp(t("^`{0}`_",i)),v=new RegExp(t("^:{0}:`{1}`{2}",o,i,r)),$=new RegExp(t("^`{1}`:{0}:{2}",o,i,r)),S=new RegExp(t("^:{0}:{1}",o,r)),M=new RegExp(t("^{0}",h)),W=new RegExp(t("^::{0}",r)),q=new RegExp(t("^\\|{0}\\|",l)),T=new RegExp(t("^{0}",a)),j=new RegExp(t("^{0}",h)),I=new RegExp(t("^::{0}",r)),A=new RegExp("^_"),C=new RegExp(t("^{0}|_",h)),H=new RegExp(t("^:{0}",r)),P=new RegExp("^::\\s*$"),z=new RegExp("^\\s+(?:>>>|In \\[\\d+\\]:)\\s");function B(e,t){var a=null;if(e.sol()&&e.match(z,!1))N(t,K,{mode:c,local:U.startState(c)});else if(e.sol()&&e.match(u))N(t,D),a="meta";else if(e.sol()&&e.match(d))N(t,B),a="header";else if(Q(t)==v||e.match(v,!1))switch(O(t)){case 0:N(t,B,L(v,1)),e.match(/^:/),a="meta";break;case 1:N(t,B,L(v,2)),e.match(s),a="keyword",e.current().match(/^(?:math|latex)/)&&(t.tmp_stex=!0);break;case 2:N(t,B,L(v,3)),e.match(/^:`/),a="meta";break;case 3:if(t.tmp_stex&&(t.tmp_stex=void 0,t.tmp={mode:n,local:U.startState(n)}),t.tmp){if("`"==e.peek()){N(t,B,L(v,4)),t.tmp=void 0;break}a=t.tmp.mode.token(e,t.tmp.local);break}N(t,B,L(v,4)),e.match(p),a="string";break;case 4:N(t,B,L(v,5)),e.match(/^`/),a="meta";break;case 5:N(t,B,L(v,6)),e.match(m);break;default:N(t,B)}else if(Q(t)==$||e.match($,!1))switch(O(t)){case 0:N(t,B,L($,1)),e.match(/^`/),a="meta";break;case 1:N(t,B,L($,2)),e.match(p),a="string";break;case 2:N(t,B,L($,3)),e.match(/^`:/),a="meta";break;case 3:N(t,B,L($,4)),e.match(s),a="keyword";break;case 4:N(t,B,L($,5)),e.match(/^:/),a="meta";break;case 5:N(t,B,L($,6)),e.match(m);break;default:N(t,B)}else if(Q(t)==S||e.match(S,!1))switch(O(t)){case 0:N(t,B,L(S,1)),e.match(/^:/),a="meta";break;case 1:N(t,B,L(S,2)),e.match(s),a="keyword";break;case 2:N(t,B,L(S,3)),e.match(/^:/),a="meta";break;case 3:N(t,B,L(S,4)),e.match(m);break;default:N(t,B)}else if(Q(t)==g||e.match(g,!1))switch(O(t)){case 0:N(t,B,L(g,1)),e.match(q),a="variable-2";break;case 1:N(t,B,L(g,2)),e.match(/^_?_?/)&&(a="link");break;default:N(t,B)}else if(e.match(E))N(t,B),a="quote";else if(e.match(R))N(t,B),a="quote";else if(e.match(y))N(t,B),e.peek()&&!e.peek().match(/^\W$/)||(a="link");else if(Q(t)==_||e.match(_,!1))switch(O(t)){case 0:!e.peek()||e.peek().match(/^\W$/)?N(t,B,L(_,1)):e.match(_);break;case 1:N(t,B,L(_,2)),e.match(/^`/),a="link";break;case 2:N(t,B,L(_,3)),e.match(p);break;case 3:N(t,B,L(_,4)),e.match(/^`_/),a="link";break;default:N(t,B)}else e.match(P)?N(t,G):e.next()&&N(t,B);return a}function D(e,t){var a=null;if(Q(t)==k||e.match(k,!1))switch(O(t)){case 0:N(t,D,L(k,1)),e.match(q),a="variable-2";break;case 1:N(t,D,L(k,2)),e.match(T);break;case 2:N(t,D,L(k,3)),e.match(j),a="keyword";break;case 3:N(t,D,L(k,4)),e.match(I),a="meta";break;default:N(t,B)}else if(Q(t)==f||e.match(f,!1))switch(O(t)){case 0:N(t,D,L(f,1)),e.match(M),a="keyword",e.current().match(/^(?:math|latex)/)?t.tmp_stex=!0:e.current().match(/^python/)&&(t.tmp_py=!0);break;case 1:N(t,D,L(f,2)),e.match(W),a="meta",(e.match(/^latex\s*$/)||t.tmp_stex)&&(t.tmp_stex=void 0,N(t,K,{mode:n,local:U.startState(n)}));break;case 2:N(t,D,L(f,3)),(e.match(/^python\s*$/)||t.tmp_py)&&(t.tmp_py=void 0,N(t,K,{mode:c,local:U.startState(c)}));break;default:N(t,B)}else if(Q(t)==x||e.match(x,!1))switch(O(t)){case 0:N(t,D,L(x,1)),e.match(A),e.match(C),a="link";break;case 1:N(t,D,L(x,2)),e.match(H),a="meta";break;default:N(t,B)}else e.match(w)?(N(t,B),a="quote"):e.match(b)?(N(t,B),a="quote"):(e.eatSpace(),e.eol()?N(t,B):(e.skipToEnd(),N(t,F),a="comment"));return a}function F(e,t){return J(e,t,"comment")}function G(e,t){return J(e,t,"meta")}function J(e,t,a){return e.eol()||e.eatSpace()?(e.skipToEnd(),a):(N(t,B),null)}function K(e,t){return t.ctx.mode&&t.ctx.local?e.sol()?(e.eatSpace()||N(t,B),null):t.ctx.mode.token(e,t.ctx.local):(N(t,B),null)}function L(e,t,a,c){return{phase:e,stage:t,mode:a,local:c}}function N(e,t,a){e.tok=t,e.ctx=a||{}}function O(e){return e.ctx.stage||0}function Q(e){return e.ctx.phase}return{startState:function(){return{tok:B,ctx:L(void 0,0)}},copyState:function(e){var t=e.ctx,a=e.tmp;return t.local&&(t={mode:t.mode,local:U.copyState(t.mode,t.local)}),a=a&&{mode:a.mode,local:U.copyState(a.mode,a.local)},{tok:e.tok,ctx:t,tmp:a}},innerMode:function(e){return e.tmp?{state:e.tmp.local,mode:e.tmp.mode}:e.ctx.mode?{state:e.ctx.local,mode:e.ctx.mode}:null},token:function(e,t){return t.tok(e,t)}}},"python","stex"),U.defineMIME("text/x-rst","rst")});