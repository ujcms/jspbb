!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(c){"use strict";function n(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function l(e){return e.state.search||(e.state.search=new n)}function o(e){return"string"==typeof e&&e==e.toLowerCase()}function u(e,n,r){return e.getSearchCursor(n,r,{caseFold:o(n),multiline:!0})}function f(e,n,r,o,t){e.openDialog?e.openDialog(n,t,{value:o,selectValueOnOpen:!0}):t(prompt(r,o))}function p(e){return e.replace(/\\([nrt\\])/g,function(e,n){return"n"==n?"\n":"r"==n?"\r":"t"==n?"\t":"\\"==n?"\\":e})}function t(e){var n=e.match(/^\/(.*)\/([a-z]*)$/);if(n)try{e=new RegExp(n[1],-1==n[2].indexOf("i")?"":"i")}catch(e){}else e=p(e);return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}function d(e,n,r){n.queryText=r,n.query=t(r),e.removeOverlay(n.overlay,o(n.query)),n.overlay=function(r,e){return"string"==typeof r?r=new RegExp(r.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e?"gi":"g"):r.global||(r=new RegExp(r.source,r.ignoreCase?"gi":"g")),{token:function(e){r.lastIndex=e.pos;var n=r.exec(e.string);if(n&&n.index==e.pos)return e.pos+=n[0].length||1,"searching";n?e.pos=n.index:e.skipToEnd()}}}(n.query,o(n.query)),e.addOverlay(n.overlay),e.showMatchesOnScrollbar&&(n.annotate&&(n.annotate.clear(),n.annotate=null),n.annotate=e.showMatchesOnScrollbar(n.query,o(n.query)))}function r(i,n,e,r){var o=l(i);if(o.query)return y(i,n);var t=i.getSelection()||o.lastQuery;if(t instanceof RegExp&&"x^"==t.source&&(t=null),e&&i.openDialog){var a=null,s=function(e,n){c.e_stop(n),e&&(e!=o.queryText&&(d(i,o,e),o.posFrom=o.posTo=i.getCursor()),a&&(a.style.opacity=1),y(i,n.shiftKey,function(e,n){var r;n.line<3&&document.querySelector&&(r=i.display.wrapper.querySelector(".CodeMirror-dialog"))&&r.getBoundingClientRect().bottom-4>i.cursorCoords(n,"window").top&&((a=r).style.opacity=.4)}))};!function(e,n,r,o,t){e.openDialog(n,o,{value:r,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){m(e)},onKeyDown:t})}(i,h(i),t,s,function(e,n){var r=c.keyName(e),o=i.getOption("extraKeys"),t=o&&o[r]||c.keyMap[i.getOption("keyMap")][r];"findNext"==t||"findPrev"==t||"findPersistentNext"==t||"findPersistentPrev"==t?(c.e_stop(e),d(i,l(i),n),i.execCommand(t)):"find"!=t&&"findPersistent"!=t||(c.e_stop(e),s(n,e))}),r&&t&&(d(i,o,t),y(i,n))}else f(i,h(i),"Search for:",t,function(e){e&&!o.query&&i.operation(function(){d(i,o,e),o.posFrom=o.posTo=i.getCursor(),y(i,n)})})}function y(r,o,t){r.operation(function(){var e=l(r),n=u(r,e.query,o?e.posFrom:e.posTo);(n.find(o)||(n=u(r,e.query,o?c.Pos(r.lastLine()):c.Pos(r.firstLine(),0))).find(o))&&(r.setSelection(n.from(),n.to()),r.scrollIntoView({from:n.from(),to:n.to()},20),e.posFrom=n.from(),e.posTo=n.to(),t&&t(n.from(),n.to()))})}function m(n){n.operation(function(){var e=l(n);e.lastQuery=e.query,e.query&&(e.query=e.queryText=null,n.removeOverlay(e.overlay),e.annotate&&(e.annotate.clear(),e.annotate=null))})}function h(e){return'<span class="CodeMirror-search-label">'+e.phrase("Search:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"}function g(n,o,t){n.operation(function(){for(var e=u(n,o);e.findNext();)if("string"!=typeof o){var r=n.getRange(e.from(),e.to()).match(o);e.replace(t.replace(/\$(\d)/g,function(e,n){return r[n]}))}else e.replace(t)})}function i(s,e){if(!s.getOption("readOnly")){var n=s.getSelection()||l(s).lastQuery,r='<span class="CodeMirror-search-label">'+(e?s.phrase("Replace all:"):s.phrase("Replace:"))+"</span>";f(s,r+function(e){return' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"}(s),r,n,function(a){a&&(a=t(a),f(s,function(e){return'<span class="CodeMirror-search-label">'+e.phrase("With:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>'}(s),s.phrase("Replace with:"),"",function(o){if(o=p(o),e)g(s,a,o);else{m(s);var t=u(s,a,s.getCursor("from")),i=function(){var e,n=t.from();!(e=t.findNext())&&(t=u(s,a),!(e=t.findNext())||n&&t.from().line==n.line&&t.from().ch==n.ch)||(s.setSelection(t.from(),t.to()),s.scrollIntoView({from:t.from(),to:t.to()}),function(e,n,r,o){e.openConfirm?e.openConfirm(n,o):confirm(r)&&o[0]()}(s,function(e){return'<span class="CodeMirror-search-label">'+e.phrase("Replace?")+"</span> <button>"+e.phrase("Yes")+"</button> <button>"+e.phrase("No")+"</button> <button>"+e.phrase("All")+"</button> <button>"+e.phrase("Stop")+"</button> "}(s),s.phrase("Replace?"),[function(){r(e)},i,function(){g(s,a,o)}]))},r=function(r){t.replace("string"==typeof a?o:o.replace(/\$(\d)/g,function(e,n){return r[n]})),i()};i()}}))})}}c.commands.find=function(e){m(e),r(e)},c.commands.findPersistent=function(e){m(e),r(e,!1,!0)},c.commands.findPersistentNext=function(e){r(e,!1,!0,!0)},c.commands.findPersistentPrev=function(e){r(e,!0,!0,!0)},c.commands.findNext=r,c.commands.findPrev=function(e){r(e,!0)},c.commands.clearSearch=m,c.commands.replace=i,c.commands.replaceAll=function(e){i(e,!0)}});